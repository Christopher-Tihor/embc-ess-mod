@if (draftSupportError) {
  <div style="display: block; color: white; background-color: orange; padding: var(--size-2); font-size: var(--size-3)">
    Error: Unable to retrieve Draft Support information.
  </div>
}
<div class="container container-frame">
  <div class="heading-container">
    <span class="page-heading">Self Serve Supports</span>
  </div>
  @if (isLoadingDraftSupport) {
    <app-loader
      style="display: flex; justify-content: space-around; margin-top: var(--size-6)"
      class="spinner"
      [strokeWidth]="10"
      [diameter]="50"
      [color]="loaderColor"
      [showLoader]="isLoadingDraftSupport"
    >
    </app-loader>
  } @else {
    <mat-horizontal-stepper class="stepper-style" [linear]="isLinear" #stepper labelPosition="bottom">
      <mat-step [stepControl]="supportDraftForm">
        <form class="support-details-form">
          <ng-template matStepLabel>Support Details</ng-template>
          <p>
            Please review the following and make any necessary edits. Required fields are marked with a red asterisk.
          </p>
          @if (showSelfServeShelterAllowanceSupport) {
            <mat-card appearance="outlined">
              <mat-card-content>
                <div style="display: flex; flex-direction: column; gap: var(--size-2)">
                  <p class="card-heading">Shelter Allowance</p>
                  <div class="card-question">
                    <label>Which people in your household require <b>Shelter Allowance</b> and for which days?</label>
                  </div>

                  <table>
                    <tr class="header-row">
                      <th style="width: 160px"></th>
                      @for (date of shelterAllowanceDates; track $index) {
                        <th>{{ date.format('MMM DD, yyy') }}</th>
                      }
                    </tr>
                    @for (person of draftSupports.householdMembers; track person.id) {
                      <tr>
                        <th>{{ getPersonName(person.id) }}</th>
                        @for (date of shelterAllowanceDates; track $index) {
                          @if (
                            supportDraftForm.controls?.shelterAllowance?.controls?.nights &&
                            getDateControl(supportDraftForm.controls.shelterAllowance.controls.nights, person, date)
                              ?.controls?.isSelected
                          ) {
                            <td>
                              <mat-checkbox
                                [formControl]="
                                  getDateControl(
                                    supportDraftForm.controls.shelterAllowance.controls.nights,
                                    person,
                                    date
                                  ).controls.isSelected
                                "
                              ></mat-checkbox>
                            </td>
                          }
                        }
                      </tr>
                    }
                  </table>
                </div>
                <div class="note-box">
                  Shelter Allowance is provided at <b>$30 per night</b> based on single occupancy, <b>$10</b> for each
                  additional adult and youth and <b>$5</b> for each additional child.
                </div>
              </mat-card-content>
            </mat-card>
          }

          @if (showSelfServeFoodSupport) {
            <mat-card appearance="outlined">
              <mat-card-content>
                <div style="flex: 1 0 450px; display: flex; flex-direction: column; gap: 30px">
                  <p class="card-heading requiredField">Food</p>
                  <div class="card-question">
                    <label>Would you like to be provided funds for <b>Restaurant Meals</b> or <b>Groceries</b>?</label>
                  </div>
                  <div>
                    <mat-radio-group
                      class="primary-radio-group"
                      [formControl]="supportDraftForm.controls.food.controls.fundsFor"
                    >
                      <mat-radio-button [value]="SupportSubCategory.FoodGroceries"> Groceries </mat-radio-button>
                      <mat-radio-button [value]="SupportSubCategory.FoodRestaurant"> Restaurant </mat-radio-button>
                    </mat-radio-group>
                  </div>
                  <!-- Groceries -->
                  @if (supportDraftForm.controls.food.controls.fundsFor.value === SupportSubCategory.FoodGroceries) {
                    <label>For which <b>days</b> does your household require <b>Groceries</b>?</label>
                    <div>
                      <table>
                        <tr class="header-row">
                          <th></th>
                          @for (date of foodGroceriesDates; track $index) {
                            <th>{{ date.format('MMM DD, yyy') }}</th>
                          }
                        </tr>
                        @for (person of draftSupports.householdMembers; track person.id) {
                          <tr>
                            <th>{{ getPersonName(person.id) }}</th>
                            @for (date of foodGroceriesDates; track $index) {
                              @if (
                                supportDraftForm.controls?.food?.controls?.groceries &&
                                getDateControl(
                                  supportDraftForm.controls.food.controls.groceries.controls.nights,
                                  person,
                                  date
                                )?.controls?.isSelected
                              ) {
                                <td>
                                  <mat-checkbox
                                    [formControl]="
                                      getDateControl(
                                        supportDraftForm.controls.food.controls.groceries.controls.nights,
                                        person,
                                        date
                                      ).controls.isSelected
                                    "
                                  ></mat-checkbox>
                                </td>
                              }
                            }
                          </tr>
                        }
                      </table>
                    </div>
                  }
                  <!-- Restaurant -->
                  @if (supportDraftForm.controls.food.controls.fundsFor.value === SupportSubCategory.FoodRestaurant) {
                    <label>Which people in your household require <b>Restaurant Meals</b>? </label>
                    <div style="display: flex; flex-direction: column">
                      @for (
                        person of supportDraftForm.controls?.food?.controls?.restaurant?.controls
                          ?.includedHouseholdMembers.controls;
                        track $index
                      ) {
                        <div>
                          <mat-checkbox [formControl]="person.controls.isSelected">
                            {{ getPersonName(person.controls.personId.value) }}
                          </mat-checkbox>
                        </div>
                      }
                    </div>
                    <label>What <b>meals</b> are required for your household?</label>
                    <div>
                      <table>
                        <tr class="header-row">
                          <th></th>
                          @for (date of foodRestaurantDates; track $index) {
                            <th>{{ date.format('MMM DD, yyy') }}</th>
                          }
                        </tr>
                        <tr>
                          <th>Breakfast</th>
                          @for (
                            meal of supportDraftForm.controls?.food?.controls?.restaurant?.controls?.mealTypes
                              ?.controls;
                            track $index
                          ) {
                            <td><mat-checkbox [formControl]="meal.controls.breakfast"></mat-checkbox></td>
                          }
                        </tr>
                        <tr>
                          <th>Lunch</th>
                          @for (
                            meal of supportDraftForm.controls?.food?.controls?.restaurant?.controls?.mealTypes
                              ?.controls;
                            track $index
                          ) {
                            <td><mat-checkbox [formControl]="meal.controls.lunch"></mat-checkbox></td>
                          }
                        </tr>
                        <tr>
                          <th>Dinner</th>
                          @for (
                            meal of supportDraftForm.controls?.food?.controls?.restaurant?.controls?.mealTypes
                              ?.controls;
                            track $index
                          ) {
                            <td><mat-checkbox [formControl]="meal.controls.dinner"></mat-checkbox></td>
                          }
                        </tr>
                      </table>
                    </div>
                  }

                  @if (
                    supportDraftForm.controls?.food?.touched &&
                    supportDraftForm.controls?.food?.controls?.fundsFor?.hasError('required')
                  ) {
                    <mat-error>Food is required</mat-error>
                  }
                </div>
                <div class="note-box">
                  Restaurant Meals are provided at <b>$12.75</b> for breakfast, <b>$14.75</b> for lunch and
                  <b>$25.50</b> for dinner per person per day. Groceries are provided at a daily rate of
                  <b>$22.50 per person</b> per day.
                </div>
              </mat-card-content>
            </mat-card>
          }

          @if (showSelfServeClothingSupport) {
            <mat-card appearance="outlined">
              <mat-card-content>
                <div style="flex: 1 0 450px; display: flex; flex-direction: column; gap: var(--size-2)">
                  <p class="card-heading">Clothing</p>
                  <div class="card-question">
                    <label>Which people in your household require <b>Clothing</b>?</label>
                  </div>
                  <div style="display: flex; flex-direction: column">
                    @for (
                      person of supportDraftForm.controls?.clothing?.controls?.includedHouseholdMembers?.controls;
                      track $index
                    ) {
                      <div>
                        <mat-checkbox [formControl]="person.controls.isSelected">
                          {{ getPersonName(person.controls.personId.value) }}
                        </mat-checkbox>
                      </div>
                    }
                  </div>
                </div>
                <div class="note-box">
                  Clothing is provided at <b>$150 per person</b> for the time you are evacuated.
                </div>
              </mat-card-content>
            </mat-card>
          }

          @if (showSelfServeIncidentsSupport) {
            <mat-card appearance="outlined">
              <mat-card-content>
                <div style="flex: 1 0 450px; display: flex; flex-direction: column; gap: var(--size-2)">
                  <p class="card-heading">Incidentals</p>
                  <div class="card-question">
                    <label>Which people in your household require <b>Incidentals</b>?</label>
                  </div>
                  <div style="display: flex; flex-direction: column">
                    @for (
                      person of supportDraftForm.controls?.incidents?.controls?.includedHouseholdMembers?.controls;
                      track $index
                    ) {
                      <div>
                        <mat-checkbox [formControl]="person.controls.isSelected">
                          {{ getPersonName(person.controls.personId.value) }}
                        </mat-checkbox>
                      </div>
                    }
                  </div>
                </div>
                <div class="note-box">
                  Incidentals are provided at <b>$50 per person</b> for the time you are evacuated.
                </div>
              </mat-card-content>
            </mat-card>
          }

          <div style="display: flex; gap: 16px; justify-content: space-between">
            <button
              type="button"
              mat-button
              class="button-s"
              style="width: 240px"
              (click)="gotoEligibilityConfirmation()"
            >
              Go Back & Edit
            </button>
            @if (draftSupports.items?.length > 0) {
              <button
                type="button"
                mat-button
                class="button-p"
                style="min-width: 240px; display: flex; align-items: center; justify-content: center"
                (click)="gotoETransfterStep(supportDraftForm)"
              >
                Next - e-Transfer Details
                @if (showButtonLoader) {
                  <app-loader
                    class="spinner"
                    [strokeWidth]="5"
                    [diameter]="30"
                    [color]="loaderColor"
                    [showLoader]="showButtonLoader"
                  >
                  </app-loader>
                }
              </button>
            }
          </div>
        </form>
      </mat-step>
      <mat-step [stepControl]="eTransferDetailsForm">
        <ng-template matStepLabel>e-Transfer Details</ng-template>
        <p>Please review the following and make any necessary edits. Required fields are marked with a red asterisk.</p>
        <form class="eTransfer-form">
          <mat-card appearance="outlined">
            <mat-card-content>
              <div style="display: flex; flex-direction: column; width: 100%">
                <div class="container-with-logo">
                  <div>
                    <p class="card-heading">e-Transfer Details *</p>
                    <div class="card-question">
                      <label> e-Transfer Recipient</label>
                    </div>
                    <mat-form-field>
                      <mat-label>Full Name</mat-label>
                      <input
                        matInput
                        placeholder="Full Name"
                        [formControl]="eTransferDetailsForm.controls.recipientName"
                        required
                      />
                      @if (eTransferDetailsForm.controls.recipientName.hasError('required')) {
                        <mat-error>e-Transfer Recipient is required</mat-error>
                      }
                    </mat-form-field>
                  </div>
                  <div>
                    <img src="../../../assets/images/interac-e-transfer-logo.png" alt="Interac e-transfer Logo" />
                  </div>
                </div>
                <div class="card-question">How would you prefer to be notified of your e-Transfer?</div>
                <mat-form-field appearance="outline">
                  <mat-select
                    [formControl]="eTransferDetailsForm.controls.notificationPreference"
                    required
                    placeholder="-- Select One"
                  >
                    @for (preference of eTransferNotificationPreferenceOptions; track preference) {
                      <mat-option [value]="preference">
                        {{ preference }}
                      </mat-option>
                    }
                  </mat-select>
                  @if (
                    eTransferDetailsForm.controls?.notificationPreference.invalid &&
                    eTransferDetailsForm.controls?.notificationPreference.hasError('required')
                  ) {
                    <mat-error>Notification Preference is required</mat-error>
                  }
                </mat-form-field>
                @if (
                  [ETransferNotificationPreference.Email, ETransferNotificationPreference.EmailAndMobile].includes(
                    eTransferDetailsForm.controls.notificationPreference.value
                  )
                ) {
                  <div style="display: flex">
                    @if (eTransferDetailsForm.controls.useEmailOnFile.value === false) {
                      <mat-form-field>
                        <mat-label>Email</mat-label>
                        <input
                          matInput
                          placeholder="Email"
                          [formControl]="eTransferDetailsForm.controls.eTransferEmail"
                          required
                        />
                        @if (eTransferDetailsForm.controls.eTransferEmail.hasError('required')) {
                          <mat-error> Email Address is required </mat-error>
                        }
                      </mat-form-field>
                    } @else {
                      <span style="margin: 12px">
                        <b>{{ profileDataService.getProfile().contactDetails.email }}</b>
                      </span>
                    }
                    @if (hasEmailAddressOnFile) {
                      <mat-checkbox [formControl]="eTransferDetailsForm.controls.useEmailOnFile">
                        Use email address on file
                      </mat-checkbox>
                    }
                  </div>
                  @if (eTransferDetailsForm.controls.useEmailOnFile.value === false) {
                    <mat-form-field>
                      <mat-label>Confirm Email</mat-label>
                      <input
                        matInput
                        placeholder="Confirm Email"
                        [formControl]="eTransferDetailsForm.controls.confirmEmail"
                        required
                      />
                      @if (eTransferDetailsForm.controls.confirmEmail.hasError('required')) {
                        <mat-error>Confirm Email Address is required</mat-error>
                      }
                      @if (eTransferDetailsForm.controls.confirmEmail.hasError('compare')) {
                        <mat-error> Email Address mismatch </mat-error>
                      }
                    </mat-form-field>
                  }
                }
                @if (
                  [ETransferNotificationPreference.Mobile, ETransferNotificationPreference.EmailAndMobile].includes(
                    eTransferDetailsForm.controls.notificationPreference.value
                  )
                ) {
                  <div>
                    @if (eTransferDetailsForm.controls.useMobileOnFile.value === false) {
                      <mat-form-field>
                        <mat-label>Mobile</mat-label>
                        <input
                          matInput
                          placeholder="Mobile"
                          [formControl]="eTransferDetailsForm.controls.eTransferMobile"
                          required
                          [imask]="phoneMask"
                        />
                        @if (eTransferDetailsForm.controls.eTransferMobile.hasError('required')) {
                          <mat-error> Mobile is required </mat-error>
                        }

                        @if (eTransferDetailsForm.controls.eTransferMobile.hasError('compare')) {
                          <mat-error> Mobile number mismatch </mat-error>
                        }
                      </mat-form-field>
                    } @else {
                      <span style="margin: 12px">
                        <b>{{ profileDataService.getProfile().contactDetails.phone }}</b>
                      </span>
                    }
                    @if (hasPhoneOnFile) {
                      <mat-checkbox [formControl]="eTransferDetailsForm.controls.useMobileOnFile">
                        Use mobile number on file
                      </mat-checkbox>
                    }
                  </div>
                  @if (eTransferDetailsForm.controls.useMobileOnFile.value === false) {
                    <mat-form-field>
                      <mat-label>Confirm Mobile</mat-label>
                      <input
                        matInput
                        placeholder="Confirm Mobile"
                        [formControl]="eTransferDetailsForm.controls.confirmMobile"
                        required
                        [imask]="phoneMask"
                      />
                      @if (eTransferDetailsForm.controls.confirmMobile.hasError('require')) {
                        <mat-error> Confirm Mobile Number is required </mat-error>
                      }

                      @if (eTransferDetailsForm.controls.confirmMobile.hasError('compare')) {
                        <mat-error> Mobile Number Mismatch </mat-error>
                      }
                    </mat-form-field>
                  }
                  @if (
                    eTransferDetailsForm.controls.notificationPreference.value ===
                      ETransferNotificationPreference.Mobile && !hasEmailAddressOnFile
                  ) {
                    <div class="card-question">
                      Kindly provide an <b>email address</b> for any further communications related to the e-transfer.
                    </div>
                    <mat-form-field>
                      <mat-label> Mobile </mat-label>
                      <input
                        matInput
                        placeholder="Email"
                        [formControl]="eTransferDetailsForm.controls.eTransferEmail"
                        required
                      />
                      @if (eTransferDetailsForm.controls.eTransferEmail.hasError('required')) {
                        <mat-error> Email Address is required </mat-error>
                      }
                    </mat-form-field>
                    <mat-form-field>
                      <mat-label>Confirm Email</mat-label>
                      <input
                        matInput
                        placeholder="Confirm Email"
                        [formControl]="eTransferDetailsForm.controls.confirmEmail"
                        required
                      />
                      @if (eTransferDetailsForm.controls.confirmEmail.hasError('compare')) {
                        <mat-error> Email Address Mismatch </mat-error>
                      }
                    </mat-form-field>
                  }
                }
              </div>
            </mat-card-content>
          </mat-card>
        </form>
        <div style="display: flex; gap: 16px; justify-content: space-between">
          <button type="button" mat-button class="button-s" style="width: 240px" matStepperPrevious>
            Go Back & Edit
          </button>
          @if (draftSupports.items?.length > 0) {
            <button
              type="button"
              mat-button
              class="button-p"
              style="width: 240px"
              (click)="gotoReviewStep(eTransferDetailsForm)"
            >
              Next - Review
              @if (showButtonLoader) {
                <app-loader class="spinner" [strokeWidth]="10" [diameter]="50" [color]="loaderColor"> </app-loader>
              }
            </button>
          }
        </div>
      </mat-step>
      <mat-step>
        <ng-template matStepLabel>Review & Submit</ng-template>
        <mat-card appearance="outlined">
          <mat-card-content>
            <div style="display: flex; flex-direction: column; gap: var(--size-2); width: 100%">
              <p class="card-heading" style="font-size: var(--size-4); margin-bottom: var(--size-5)">Review Details</p>
              <div style="display: flex; justify-content: space-between">
                <p class="card-heading">Support Details</p>
                <button class="edit-image" mat-icon-button aria-label="Edit" (click)="gotoStep('supportDetails')">
                  <img src="/assets/images/edit.svg" height="35" width="35" />
                  <img src="/assets/images/edit_onhover.svg" height="35" width="35" />
                </button>
              </div>
              <hr />
              @if (showSelfServeShelterAllowanceSupport) {
                <div style="display: flex">
                  <div style="width: 240px">Shelter Allowance</div>
                  <div style="width: 160px">
                    <b>{{ supportDraftForm.controls.shelterAllowance.controls.totalAmount.value }}</b>
                  </div>
                </div>
              }
              @if (showSelfServeFoodSupport) {
                @if (supportDraftForm.controls.food.controls.fundsFor.value === SupportSubCategory.FoodGroceries) {
                  <div style="display: flex">
                    <div style="width: 240px">Grocery</div>
                    <div style="width: 160px">
                      <b>{{ supportDraftForm.controls.food.controls.groceries.controls.totalAmount.value }}</b>
                    </div>
                  </div>
                }
                @if (supportDraftForm.controls.food.controls.fundsFor.value === SupportSubCategory.FoodRestaurant) {
                  <div style="display: flex">
                    <div style="width: 240px">Restaurant</div>
                    <div style="width: 160px">
                      <b>{{ supportDraftForm.controls.food.controls.restaurant.controls.totalAmount.value }}</b>
                    </div>
                  </div>
                }
              }
              @if (showSelfServeClothingSupport) {
                <div style="display: flex">
                  <div style="width: 240px">Clothing</div>
                  <div style="width: 160px">
                    <b>{{ supportDraftForm.controls.clothing.controls.totalAmount.value }}</b>
                  </div>
                </div>
              }
              @if (showSelfServeIncidentsSupport) {
                <div style="display: flex">
                  <div style="width: 240px">Incidentals</div>
                  <div style="width: 160px">
                    <b>{{ supportDraftForm.controls.incidents.controls.totalAmount.value }}</b>
                  </div>
                </div>
              }

              <div style="display: flex">
                <div style="width: 240px"><b>Total Amount</b></div>
                <div style="width: 160px">
                  <b>{{ supportDraftForm.controls.totals.value }}</b>
                </div>
              </div>

              <div style="display: flex; justify-content: space-between">
                <p class="card-heading">e-Transfer Recipient Details</p>
                <button class="edit-image" mat-icon-button aria-label="Edit" (click)="gotoStep('eTransfer')">
                  <img src="/assets/images/edit.svg" height="35" width="35" />
                  <img src="/assets/images/edit_onhover.svg" height="35" width="35" />
                </button>
              </div>
              <hr />

              <div style="display: flex">
                <div style="width: 240px">e-Transfer Recipient:</div>
                <div style="width: 160px">
                  <b>{{ eTransferDetailsForm.controls.recipientName.value }}</b>
                </div>
              </div>

              @switch (eTransferDetailsForm.controls.notificationPreference.value) {
                @case (ETransferNotificationPreference.Email) {
                  <div style="display: flex">
                    <div style="width: 240px">e-Transfer Notification:</div>
                    <div style="width: 160px">
                      <b>{{ eTransferDetailsForm.controls.eTransferEmail.value }}</b>
                    </div>
                  </div>
                }
                @case (ETransferNotificationPreference.Mobile) {
                  <div style="display: flex">
                    <div style="width: 240px">e-Transfer Notification:</div>
                    <div style="width: 160px">
                      <b>{{ eTransferDetailsForm.controls.eTransferMobile.value }}</b>
                    </div>
                  </div>
                  <div style="display: flex">
                    <div style="width: 240px">Contact Email Address</div>
                    <div style="width: 160px">
                      <b>{{ eTransferDetailsForm.controls.eTransferEmail.value }}</b>
                    </div>
                  </div>
                }
                @case (ETransferNotificationPreference.EmailAndMobile) {
                  <div style="display: flex">
                    <div style="width: 240px">e-Transfer Notification:</div>
                    <div style="width: 160px">
                      <b>{{ eTransferDetailsForm.controls.eTransferMobile.value }}</b>
                    </div>
                  </div>
                  <div style="display: flex">
                    <div style="width: 240px">&nbsp;</div>
                    <div style="width: 160px">
                      <b>{{ eTransferDetailsForm.controls.eTransferEmail.value }}</b>
                    </div>
                  </div>
                }
              }
              <div style="display: flex">
                <div style="width: 240px">Contact Email Address:</div>
                <div style="width: 160px">
                  <b>{{ eTransferDetailsForm.controls.eTransferEmail.value }}</b>
                </div>
              </div>

              <div style="display: flex; justify-content: space-between">
                <p class="card-heading">Acknowledgment</p>
              </div>
              <hr />
              <p>
                <b>
                  You are being provided with a one-time digital payment for supports. These funds have been provided
                  for the sole purpose to meet essential needs of individuals and their household members.
                </b>
              </p>
              <mat-checkbox>
                I acknowledge that by accepting this digital payment, I agree to use the funds exclusively for meeting
                my basic needs as outlined above. I understand that purchases such as alcohol, tobacco, cannabis
                products, entertainment goods or services (such as online gaming), and luxury items are not permissible.
              </mat-checkbox>
              <mat-checkbox>
                I acknowledge that by accepting this digital payment, I am able to meet my own needs and will not seek
                further supports during the valid timeframe of <b>April 4 2024</b> to <b>April 6 2024</b>.
              </mat-checkbox>
              <mat-checkbox>
                I certify that all information I have provided is accurate to the best of my knowledge. If information
                is found to be untrue, this may result in repayment of funds already received. Intentional provision of
                inaccurate information may be investigated, and legal action may be undertaken.
              </mat-checkbox>

              <div
                style="text-align: center; border: 4px solid orange; padding: 16px; background: #eee; font-size: 20px"
              >
                <p>
                  If you haven't set up auto-deposit for Interac e-Transfer, the security answer for the e-transfer will
                  be your ESS File Number, which is <b>VIC12345</b>.
                </p>
                <p>You can find your ESS File number under the Current Events tab of your ERA profile.</p>
              </div>
            </div>
          </mat-card-content>
        </mat-card>
        <div>
          <button type="button" mat-button class="button-s" matStepperPrevious style="width: 240px">
            Go Back & Edit
          </button>
          @if (draftSupports.items?.length > 0) {
            <button type="button" mat-button class="button-p" style="width: 240px" (click)="submit()">
              Next- Submit
            </button>
          }
        </div>
      </mat-step>
    </mat-horizontal-stepper>
  }
</div>
