apiVersion: v1
kind: Template
metadata:
  name: supporters-portal-env-promotions
  annotations:
    description: "Pipelines to promote images to higher environments"
objects:
  - kind: "BuildConfig"
    apiVersion: "v1"
    metadata:
      name: "supporters-portal-promote-test"
    spec:
      strategy:
        jenkinsPipelineStrategy:
          jenkinsfile: |-
            node {
              stage('tag image'){
                openshiftTag(srcStream: 'supporters-portal-api', srcTag: 'latest', destStream: 'supporters-portal-api', destTag: 'test')
                openshiftTag(srcStream: 'supporters-portal-ui', srcTag: 'latest', destStream: 'supporters-portal-ui', destTag: 'test')
                openshiftVerifyDeployment(namespace: 'pbiizm-test', depCfg: 'test-supporters-portal-api')
                openshiftVerifyDeployment(namespace: 'pbiizm-test', depCfg: 'test-supporters-portal-ui')
              }
            }
  - kind: "BuildConfig"
    apiVersion: "v1"
    metadata:
      name: "supporters-portal-promote-training"
    spec:
      strategy:
        jenkinsPipelineStrategy:
          jenkinsfile: |-
            node {
              stage('approval') {
                timeout(time: 30, unit: 'DAYS') {
                  input message: "Deploy to training?"
                }
              }
              stage('tag image'){
                openshiftTag(srcStream: 'supporters-portal-api', srcTag: 'test', destStream: 'supporters-portal-api', destTag: 'training')
                openshiftTag(srcStream: 'supporters-portal-ui', srcTag: 'test', destStream: 'supporters-portal-ui', destTag: 'training')
                openshiftVerifyDeployment(namespace: 'pbiizm-test', depCfg: 'training-supporters-portal-api')
                openshiftVerifyDeployment(namespace: 'pbiizm-test', depCfg: 'training-supporters-portal-ui')
              }
            }
  - kind: "BuildConfig"
    apiVersion: "v1"
    metadata:
      name: "supporters-portal-promote-prod"
    spec:
      strategy:
        jenkinsPipelineStrategy:
          jenkinsfile: |-
            node {
              stage('approval') {
                timeout(time: 30, unit: 'DAYS') {
                  input message: "Deploy to prod?"
                }    
              }
               stage('tag image'){
                openshiftTag(srcStream: 'supporters-portal-api', srcTag: 'test', destStream: 'supporters-portal-api', destTag: 'prod')
                openshiftTag(srcStream: 'supporters-portal-ui', srcTag: 'test', destStream: 'supporters-portal-ui', destTag: 'prod')
                openshiftVerifyDeployment(namespace: 'pbiizm-prod', depCfg: 'production-supporters-portal-api')
                openshiftVerifyDeployment(namespace: 'pbiizm-prod', depCfg: 'production-supporters-portal-ui')
              }
            }
